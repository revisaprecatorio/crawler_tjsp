# üíæ Script de Backup Completo do Sistema - Crawler TJSP
# Vers√£o: 1.0
# Data: 2025-10-06
# Descri√ß√£o: Backup automatizado de todos os componentes cr√≠ticos antes de upgrade

# Requer execu√ß√£o como Administrator
#Requires -RunAsAdministrator

# Configura√ß√µes
$timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
$backupRoot = "C:\backups"
$backupDir = Join-Path $backupRoot "backup_$timestamp"
$projectPath = "C:\projetos\crawler_tjsp"
$certsPath = "C:\certs"

# Cores para output
function Write-Step {
    param([string]$Message)
    Write-Host "üîµ $Message" -ForegroundColor Cyan
}

function Write-Success {
    param([string]$Message)
    Write-Host "‚úÖ $Message" -ForegroundColor Green
}

function Write-Warning {
    param([string]$Message)
    Write-Host "‚ö†Ô∏è  $Message" -ForegroundColor Yellow
}

function Write-Error-Custom {
    param([string]$Message)
    Write-Host "‚ùå $Message" -ForegroundColor Red
}

# Banner
Write-Host "`n" -NoNewline
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host "  üíæ BACKUP COMPLETO DO SISTEMA - CRAWLER TJSP" -ForegroundColor Cyan
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Cyan
Write-Host "  Data: $(Get-Date -Format 'dd/MM/yyyy HH:mm:ss')" -ForegroundColor Gray
Write-Host "  Destino: $backupDir" -ForegroundColor Gray
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`n" -ForegroundColor Cyan

$startTime = Get-Date

# ========================================
# ETAPA 1: Criar Estrutura de Diret√≥rios
# ========================================
Write-Step "ETAPA 1/8: Criando estrutura de diret√≥rios..."

$subdirs = @(
    "01_sistema",
    "02_codigo",
    "03_certificados",
    "04_chrome_profile",
    "05_logs",
    "06_database",
    "07_scripts",
    "08_docs"
)

try {
    # Criar diret√≥rio raiz do backup
    New-Item -ItemType Directory -Path $backupDir -Force | Out-Null
    
    # Criar subdiret√≥rios
    foreach ($dir in $subdirs) {
        $fullPath = Join-Path $backupDir $dir
        New-Item -ItemType Directory -Path $fullPath -Force | Out-Null
    }
    
    Write-Success "Estrutura de diret√≥rios criada"
} catch {
    Write-Error-Custom "Erro ao criar diret√≥rios: $_"
    exit 1
}

# ========================================
# ETAPA 2: Capturar Informa√ß√µes do Sistema
# ========================================
Write-Step "ETAPA 2/8: Capturando informa√ß√µes do sistema..."

try {
    $sysInfoPath = Join-Path $backupDir "01_sistema"
    
    # Informa√ß√µes do Windows
    Get-ComputerInfo | Out-File "$sysInfoPath\computer_info.txt"
    
    # Vers√£o do Windows
    $osInfo = Get-CimInstance Win32_OperatingSystem
    @{
        "Nome" = $osInfo.Caption
        "Vers√£o" = $osInfo.Version
        "Arquitetura" = $osInfo.OSArchitecture
        "SerialNumber" = $osInfo.SerialNumber
        "InstallDate" = $osInfo.InstallDate
    } | ConvertTo-Json | Out-File "$sysInfoPath\windows_version.json"
    
    # Vari√°veis de ambiente
    Get-ChildItem Env: | Export-Csv "$sysInfoPath\environment_variables.csv" -NoTypeInformation
    
    # PATH espec√≠fico
    @{
        "PATH" = $env:Path -split ";"
        "PYTHONPATH" = $env:PYTHONPATH
    } | ConvertTo-Json | Out-File "$sysInfoPath\path_variables.json"
    
    # Software instalado
    Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |
        Select-Object DisplayName, DisplayVersion, Publisher, InstallDate |
        Export-Csv "$sysInfoPath\installed_software.csv" -NoTypeInformation
    
    # Vers√µes cr√≠ticas
    $versions = @{
        "Python" = & python --version 2>&1 | Out-String
        "Git" = & git --version 2>&1 | Out-String
        "ChromeDriver" = & chromedriver --version 2>&1 | Out-String
        "Chrome" = (Get-Item "C:\Program Files\Google\Chrome\Application\chrome.exe").VersionInfo.FileVersion
    }
    $versions | ConvertTo-Json | Out-File "$sysInfoPath\software_versions.json"
    
    # Servi√ßos relevantes
    Get-Service | Where-Object {
        $_.DisplayName -like "*Crawler*" -or 
        $_.DisplayName -like "*TJSP*" -or
        $_.DisplayName -like "*PostgreSQL*" -or
        $_.DisplayName -like "*OpenSSH*"
    } | Export-Csv "$sysInfoPath\services.csv" -NoTypeInformation
    
    # Tarefas agendadas
    Get-ScheduledTask | Where-Object {
        $_.TaskName -like "*Crawler*" -or 
        $_.TaskName -like "*TJSP*"
    } | Export-Csv "$sysInfoPath\scheduled_tasks.csv" -NoTypeInformation
    
    # Regras de firewall
    Get-NetFirewallRule | Where-Object {
        $_.DisplayName -like "*RDP*" -or 
        $_.DisplayName -like "*SSH*" -or 
        $_.DisplayName -like "*PostgreSQL*"
    } | Select-Object DisplayName, Direction, Action, Enabled, Profile |
        Export-Csv "$sysInfoPath\firewall_rules.csv" -NoTypeInformation
    
    # Portas listening
    Get-NetTCPConnection | Where-Object {$_.State -eq "Listen"} |
        Select-Object LocalAddress, LocalPort, OwningProcess |
        Export-Csv "$sysInfoPath\listening_ports.csv" -NoTypeInformation
    
    Write-Success "Informa√ß√µes do sistema capturadas"
} catch {
    Write-Warning "Erro ao capturar informa√ß√µes do sistema: $_"
}

# ========================================
# ETAPA 3: Backup do C√≥digo do Projeto
# ========================================
Write-Step "ETAPA 3/8: Fazendo backup do c√≥digo do projeto..."

try {
    $codigoPath = Join-Path $backupDir "02_codigo"
    
    if (Test-Path $projectPath) {
        # Copiar projeto completo (exceto .git para economizar espa√ßo)
        Write-Host "  üìÅ Copiando $projectPath..." -ForegroundColor Gray
        
        # Copiar arquivos Python e configura√ß√£o
        Copy-Item "$projectPath\*.py" $codigoPath -Force -ErrorAction SilentlyContinue
        Copy-Item "$projectPath\*.txt" $codigoPath -Force -ErrorAction SilentlyContinue
        Copy-Item "$projectPath\*.md" $codigoPath -Force -ErrorAction SilentlyContinue
        Copy-Item "$projectPath\.env" $codigoPath -Force -ErrorAction SilentlyContinue
        
        # Copiar diret√≥rios importantes
        $dirsToBackup = @("scripts", "docs", "windows-server", "chrome_extension")
        foreach ($dir in $dirsToBackup) {
            $sourcePath = Join-Path $projectPath $dir
            if (Test-Path $sourcePath) {
                $destPath = Join-Path $codigoPath $dir
                Copy-Item $sourcePath $destPath -Recurse -Force
            }
        }
        
        # Copiar virtual environment (apenas pacotes instalados)
        $venvPath = Join-Path $projectPath ".venv"
        if (Test-Path $venvPath) {
            Write-Host "  üì¶ Exportando lista de pacotes Python..." -ForegroundColor Gray
            & "$venvPath\Scripts\pip.exe" freeze | Out-File "$codigoPath\requirements_frozen.txt"
        }
        
        # Informa√ß√µes do reposit√≥rio Git
        Push-Location $projectPath
        git log -1 --pretty=format:"%H%n%an%n%ae%n%ad%n%s" | Out-File "$codigoPath\git_last_commit.txt"
        git status --short | Out-File "$codigoPath\git_status.txt"
        git branch --show-current | Out-File "$codigoPath\git_branch.txt"
        Pop-Location
        
        Write-Success "C√≥digo do projeto copiado"
    } else {
        Write-Warning "Projeto n√£o encontrado em $projectPath"
    }
} catch {
    Write-Warning "Erro ao fazer backup do c√≥digo: $_"
}

# ========================================
# ETAPA 4: Backup de Certificados
# ========================================
Write-Step "ETAPA 4/8: Fazendo backup de certificados..."

try {
    $certPath = Join-Path $backupDir "03_certificados"
    
    # Copiar arquivo .pfx do disco
    if (Test-Path "$certsPath\certificado.pfx") {
        Copy-Item "$certsPath\certificado.pfx" $certPath -Force
        $certSize = (Get-Item "$certPath\certificado.pfx").Length
        Write-Host "  üìÑ certificado.pfx copiado ($certSize bytes)" -ForegroundColor Gray
    }
    
    # Exportar certificado do Windows Certificate Store
    $cert = Get-ChildItem -Path Cert:\CurrentUser\My | Where-Object {$_.Subject -like "*517.648.902-30*"}
    
    if ($cert) {
        Write-Host "  üîê Exportando certificado do Certificate Store..." -ForegroundColor Gray
        
        # Exportar chave p√∫blica (.cer)
        Export-Certificate -Cert $cert -FilePath "$certPath\certificado_public.cer" | Out-Null
        
        # Exportar com chave privada (.pfx) - REQUER SENHA
        $password = ConvertTo-SecureString -String "903205" -Force -AsPlainText
        Export-PfxCertificate -Cert $cert -FilePath "$certPath\certificado_from_store.pfx" -Password $password | Out-Null
        
        # Salvar informa√ß√µes do certificado
        @{
            "Subject" = $cert.Subject
            "Issuer" = $cert.Issuer
            "Thumbprint" = $cert.Thumbprint
            "NotBefore" = $cert.NotBefore
            "NotAfter" = $cert.NotAfter
            "HasPrivateKey" = $cert.HasPrivateKey
        } | ConvertTo-Json | Out-File "$certPath\certificate_info.json"
        
        Write-Success "Certificados exportados"
    } else {
        Write-Warning "Certificado n√£o encontrado no Certificate Store"
    }
    
    # Documentar senha (IMPORTANTE!)
    @"
INFORMA√á√ïES DO CERTIFICADO DIGITAL
===================================

Arquivo: certificado.pfx
Senha: 903205
CPF Titular: 517.648.902-30
N√∫mero do Pedido: 25424636
C√≥digo de Instala√ß√£o: 669-281

‚ö†Ô∏è MANTENHA ESTA INFORMA√á√ÉO SEGURA!
"@ | Out-File "$certPath\SENHA_CERTIFICADO.txt"
    
} catch {
    Write-Warning "Erro ao fazer backup de certificados: $_"
}

# ========================================
# ETAPA 5: Backup Perfil Chrome
# ========================================
Write-Step "ETAPA 5/8: Documentando perfil Chrome..."

try {
    $chromePath = Join-Path $backupDir "04_chrome_profile"
    
    # Informa√ß√µes do perfil (n√£o copiar arquivos - podem ser grandes)
    $profilePath = "C:\Users\Administrator\AppData\Local\Google\Chrome\User Data\Default"
    
    @"
PERFIL CHROME - INFORMA√á√ïES
============================

Perfil sincronizado: revisa.precatorio@gmail.com
Localiza√ß√£o: $profilePath

EXTENS√ïES INSTALADAS:
---------------------
Para restaurar:
1. Fazer login no Chrome com revisa.precatorio@gmail.com
2. Extens√µes ser√£o sincronizadas automaticamente
3. Verificar em chrome://extensions/

CR√çTICO:
- Web Signer deve estar instalado
- Verificar comunica√ß√£o com aplicativo nativo
- Testar login certificado ap√≥s restore

NOTA: Perfil sincronizado via Google Account, n√£o requer backup de arquivos locais.
"@ | Out-File "$chromePath\chrome_profile_info.txt"
    
    # Tentar listar extens√µes
    $extensionsPath = Join-Path $profilePath "Extensions"
    if (Test-Path $extensionsPath) {
        Get-ChildItem $extensionsPath | Select-Object Name, LastWriteTime |
            Export-Csv "$chromePath\extensions_list.csv" -NoTypeInformation
    }
    
    Write-Success "Informa√ß√µes do Chrome documentadas"
} catch {
    Write-Warning "Erro ao documentar perfil Chrome: $_"
}

# ========================================
# ETAPA 6: Backup de Logs
# ========================================
Write-Step "ETAPA 6/8: Copiando logs..."

try {
    $logsPath = Join-Path $backupDir "05_logs"
    
    # Logs do projeto
    $projectLogsPath = Join-Path $projectPath "logs"
    if (Test-Path $projectLogsPath) {
        Copy-Item "$projectLogsPath\*" $logsPath -Recurse -Force -ErrorAction SilentlyContinue
        Write-Success "Logs do projeto copiados"
    } else {
        Write-Host "  ‚ÑπÔ∏è  Nenhum log encontrado" -ForegroundColor Gray
    }
    
    # Logs do Windows (√∫ltimos 100 eventos de Application)
    Get-EventLog -LogName Application -Newest 100 |
        Export-Csv "$logsPath\windows_application_events.csv" -NoTypeInformation
    
} catch {
    Write-Warning "Erro ao copiar logs: $_"
}

# ========================================
# ETAPA 7: Backup PostgreSQL (se aplic√°vel)
# ========================================
Write-Step "ETAPA 7/8: Verificando PostgreSQL..."

try {
    $dbPath = Join-Path $backupDir "06_database"
    
    $pgService = Get-Service | Where-Object {$_.Name -like "*postgresql*"}
    
    if ($pgService) {
        Write-Host "  üóÑÔ∏è  PostgreSQL detectado, fazendo backup..." -ForegroundColor Gray
        
        $pgBinPath = "C:\Program Files\PostgreSQL\15\bin"
        
        if (Test-Path $pgBinPath) {
            # Dump completo
            & "$pgBinPath\pg_dumpall.exe" -U postgres -f "$dbPath\all_databases_backup.sql" 2>&1 | Out-Null
            
            # Dump espec√≠fico (se existir)
            & "$pgBinPath\pg_dump.exe" -U revisa_user -d revisa_db -f "$dbPath\revisa_db_backup.sql" 2>&1 | Out-Null
            
            # Arquivos de configura√ß√£o
            $pgDataPath = "C:\Program Files\PostgreSQL\15\data"
            if (Test-Path "$pgDataPath\postgresql.conf") {
                Copy-Item "$pgDataPath\postgresql.conf" $dbPath -Force
                Copy-Item "$pgDataPath\pg_hba.conf" $dbPath -Force
            }
            
            Write-Success "Backup PostgreSQL conclu√≠do"
        }
    } else {
        Write-Host "  ‚ÑπÔ∏è  PostgreSQL n√£o instalado (pode estar usando banco remoto)" -ForegroundColor Gray
        
        @"
PostgreSQL n√£o detectado localmente.

Se estiver usando banco remoto:
- Credenciais est√£o no arquivo .env
- Backup deve ser feito no servidor remoto
- Nenhuma a√ß√£o necess√°ria aqui
"@ | Out-File "$dbPath\database_remote_note.txt"
    }
} catch {
    Write-Warning "Erro ao fazer backup PostgreSQL: $_"
}

# ========================================
# ETAPA 8: Gerar Manifesto e Documenta√ß√£o
# ========================================
Write-Step "ETAPA 8/8: Gerando manifesto e documenta√ß√£o..."

try {
    $manifest = @"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë             BACKUP COMPLETO - CRAWLER TJSP                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Data do Backup: $(Get-Date -Format "dd/MM/yyyy HH:mm:ss")
Servidor: 62.171.143.88 (Contabo Cloud VPS 10)
Sistema Operacional: $($(Get-CimInstance Win32_OperatingSystem).Caption)
Hostname: $env:COMPUTERNAME
Usu√°rio: $env:USERNAME

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìÅ ESTRUTURA DO BACKUP:

01_sistema/
    - Informa√ß√µes do Windows
    - Vari√°veis de ambiente
    - Software instalado
    - Servi√ßos e tarefas agendadas
    - Regras de firewall

02_codigo/
    - C√≥digo Python completo
    - Arquivo .env
    - Scripts e documenta√ß√£o
    - requirements.txt (pacotes instalados)
    - Informa√ß√µes do Git

03_certificados/
    - certificado.pfx (arquivo original)
    - certificado_from_store.pfx (export do Windows)
    - certificado_public.cer (chave p√∫blica)
    - certificate_info.json (metadados)
    - SENHA_CERTIFICADO.txt (üìå IMPORTANTE!)

04_chrome_profile/
    - Documenta√ß√£o do perfil sincronizado
    - Lista de extens√µes instaladas

05_logs/
    - Logs do crawler
    - Event logs do Windows

06_database/
    - Dumps PostgreSQL (se aplic√°vel)
    - Arquivos de configura√ß√£o

07_scripts/ (n√£o utilizado neste backup)

08_docs/ (n√£o utilizado neste backup)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üîê INFORMA√á√ïES CR√çTICAS:

Certificado Digital:
- Arquivo: certificado.pfx
- Senha: 903205
- CPF: 517.648.902-30

Perfil Chrome:
- Conta: revisa.precatorio@gmail.com
- Extens√£o cr√≠tica: Web Signer

Software Principal:
- Python: $(& python --version 2>&1)
- Chrome: $($(Get-Item "C:\Program Files\Google\Chrome\Application\chrome.exe" -ErrorAction SilentlyContinue).VersionInfo.FileVersion)
- Git: $(& git --version 2>&1)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìù INSTRU√á√ïES DE RESTORE:

1. VIA SNAPSHOT CONTABO (RECOMENDADO):
   - Painel Contabo ‚Üí Snapshots
   - Selecionar snapshot: pre-upgrade-to-ws2025-2025-10-06
   - Clicar "Restore"
   - Aguardar 10-20 minutos
   - ‚úÖ Sistema volta ao estado exato do backup

2. VIA RESTORE MANUAL:
   - Consultar arquivo: RESTORE_GUIDE.md
   - Instalar Windows Server 2025
   - Executar restore_from_backup.ps1
   - Importar certificado
   - Instalar software listado
   - Restaurar c√≥digo e configura√ß√µes

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚ö†Ô∏è  ATEN√á√ÉO:

- SNAPSHOT Contabo √© seu seguro principal!
- Este ZIP √© backup secund√°rio/redundante
- Mantenha em M√öLTIPLOS locais seguros
- N√£o compartilhe (cont√©m senha do certificado)
- Valide hash MD5 ap√≥s transferir

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä ESTAT√çSTICAS:

Total de arquivos: $(Get-ChildItem $backupDir -Recurse | Measure-Object).Count
Tamanho total: calculando...
Hash MD5: ser√° gerado ap√≥s compacta√ß√£o

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Backup gerado por: backup_complete_system.ps1 v1.0
Respons√°vel: Persival Balleste
Projeto: Crawler TJSP - Migra√ß√£o Windows Server

Para suporte, consulte: windows-server/BACKUP_GUIDE.md

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"@

    $manifest | Out-File "$backupDir\BACKUP_MANIFEST.txt" -Encoding UTF8
    
    Write-Success "Manifesto gerado"
} catch {
    Write-Warning "Erro ao gerar manifesto: $_"
}

# ========================================
# COMPACTAR BACKUP
# ========================================
Write-Step "Compactando backup..."

try {
    $zipFile = "$backupRoot\BACKUP_COMPLETO_PRE_UPGRADE_$timestamp.zip"
    
    Write-Host "  üóúÔ∏è  Criando arquivo ZIP..." -ForegroundColor Gray
    Write-Host "     Isso pode levar alguns minutos..." -ForegroundColor Gray
    
    Compress-Archive -Path $backupDir -DestinationPath $zipFile -CompressionLevel Optimal
    
    # Calcular hash MD5
    $hash = Get-FileHash $zipFile -Algorithm MD5
    $hash.Hash | Out-File "$zipFile.md5"
    
    # Tamanho do arquivo
    $zipSize = (Get-Item $zipFile).Length
    $zipSizeGB = [math]::Round($zipSize / 1GB, 2)
    
    Write-Success "Backup compactado"
    Write-Host "  üì¶ Arquivo: $zipFile" -ForegroundColor Gray
    Write-Host "  üìä Tamanho: $zipSizeGB GB" -ForegroundColor Gray
    Write-Host "  üîê MD5: $($hash.Hash)" -ForegroundColor Gray
    
} catch {
    Write-Error-Custom "Erro ao compactar backup: $_"
}

# ========================================
# RESUMO FINAL
# ========================================
$endTime = Get-Date
$duration = $endTime - $startTime

Write-Host "`n" -NoNewline
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
Write-Host "  ‚úÖ BACKUP CONCLU√çDO COM SUCESSO!" -ForegroundColor Green
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
Write-Host "  üìÅ Diret√≥rio: $backupDir" -ForegroundColor Gray
Write-Host "  üì¶ Arquivo ZIP: BACKUP_COMPLETO_PRE_UPGRADE_$timestamp.zip" -ForegroundColor Gray
Write-Host "  üìä Tamanho: $zipSizeGB GB" -ForegroundColor Gray
Write-Host "  üîê MD5: $($hash.Hash)" -ForegroundColor Gray
Write-Host "  ‚è±Ô∏è  Tempo total: $($duration.Minutes) min $($duration.Seconds) seg" -ForegroundColor Gray
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green

Write-Host "`nüìã PR√ìXIMOS PASSOS:" -ForegroundColor Cyan
Write-Host "  1. Transferir ZIP para computador local via SCP/RDP" -ForegroundColor Yellow
Write-Host "  2. Validar hash MD5 ap√≥s transfer√™ncia" -ForegroundColor Yellow
Write-Host "  3. Fazer c√≥pia adicional em HD externo/cloud" -ForegroundColor Yellow
Write-Host "  4. Criar snapshot na Contabo (CR√çTICO!)" -ForegroundColor Yellow
Write-Host "  5. Validar checklist completo em BACKUP_GUIDE.md" -ForegroundColor Yellow
Write-Host "  6. ‚úÖ Proceder com upgrade para Windows Server 2025" -ForegroundColor Yellow

Write-Host "`n‚ö†Ô∏è  LEMBRE-SE:" -ForegroundColor Red
Write-Host "  - Criar SNAPSHOT Contabo antes de qualquer mudan√ßa!" -ForegroundColor Red
Write-Host "  - Manter backup em M√öLTIPLOS locais seguros" -ForegroundColor Red
Write-Host "  - Validar hash MD5 ap√≥s transferir arquivo" -ForegroundColor Red

Write-Host "`n"


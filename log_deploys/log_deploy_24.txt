=================================================================================
LOG DE DEPLOY #24 - DESCOBERTA: PROBLEMA DE CREDENCIAIS
=================================================================================

Data: 2025-10-01 20:30:00
Servidor: srv987902.hstgr.cloud (72.60.62.124)
Status: ⏸️ AGUARDANDO VALIDAÇÃO DE CREDENCIAIS

=================================================================================
CONTEXTO
=================================================================================

Após implementar Selenium Grid com sucesso e modificar código para priorizar
login CPF/senha, realizamos testes manuais de autenticação e descobrimos que
o problema NÃO é técnico, mas sim de CREDENCIAIS INVÁLIDAS.

=================================================================================
TESTES MANUAIS REALIZADOS
=================================================================================

### TESTE 1: CPF do Certificado (517.648.902-30) ###

Tentativa 1: Login com CPF/CNPJ + Senha
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: CPF/CNPJ
- CPF: 517.648.902-30
- Senha: 903205
- Resultado: ❌ "Usuário ou senha inválidos"

Tentativa 2: Login com Certificado Digital
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: Certificado digital
- Certificado: FLAVIO EDUARDO CAPPI:517648
- Senha: 903205
- Resultado: ❌ "Usuário ou senha inválidos"

Tentativa 3: Login com CPF sem formatação
- CPF: 51764890230
- Senha: 903205
- Resultado: ❌ "Usuário ou senha inválidos"

CONCLUSÃO TESTE 1:
- Credenciais do certificado estão INCORRETAS
- CPF pode não estar cadastrado no Portal e-SAJ OU
- Senha 903205 não é a senha do Portal (é a senha do .pfx)

---

### TESTE 2: CPF Pessoal (073.019.918-51) ###

Tentativa: Login com CPF/CNPJ + Senha válida
- URL: https://esaj.tjsp.jus.br/sajcas/login
- Aba: CPF/CNPJ
- CPF: 073.019.918-51
- Senha: [SENHA VÁLIDA]
- Resultado: ✅ LOGIN BEM-SUCEDIDO!

Fluxo de Autenticação:
1. Preencheu CPF e senha
2. Clicou em "Entrar"
3. Sistema pediu validação 2FA
4. Código enviado para email (per***********@gmail.com)
5. Inseriu código: 188383
6. Redirecionado para Portal e-SAJ
7. Login confirmado: "Persival Balleste Prates"

Limitação:
- ⚠️ Conta não tem perfil de advogado
- ⚠️ Não consegue acessar processos judiciais
- ⚠️ Apenas acesso básico ao Portal

CONCLUSÃO TESTE 2:
- Sistema de autenticação CPF/senha FUNCIONA PERFEITAMENTE
- Não requer certificado digital
- Sistema tem 2FA por email (pode ser desabilitado)
- Problema é apenas credenciais incorretas do certificado

=================================================================================
ANÁLISE TÉCNICA
=================================================================================

### Descoberta 1: Site Aceita CPF/Senha SEM Certificado ###

HTML da página de login mostra DUAS ABAS INDEPENDENTES:

1. Aba "CPF/CNPJ" (linkAbaCpf):
   - Campos: username, password
   - Funciona SEM certificado digital
   - Testado e confirmado funcionando

2. Aba "Certificado digital" (linkAbaCertificado):
   - Requer plugin Web Signer instalado
   - Dropdown de certificados desabilitado sem plugin
   - Popup modal: "Web Signer não instalado"
   - AINDA PRECISA de senha do Portal e-SAJ

### Descoberta 2: Certificado Requer Web Signer ###

HTML mostra popup bloqueando uso de certificado:

<div id="webSignerNaoInstalado" style="display: block;">
    <p>Para utilização do certificado digital no Portal e-SAJ é necessário 
       a instalação do plug-in Web Signer...</p>
</div>

Dropdown de certificados desabilitado:
<select id="certificados" ... disabled="disabled">

CONCLUSÃO:
- Selenium Grid NÃO tem Web Signer instalado
- Certificado digital NÃO funciona em containers Docker
- Login CPF/senha é a ÚNICA opção viável para automação

### Descoberta 3: Senha do .pfx ≠ Senha do Portal ###

IMPORTANTE: Existem DUAS senhas diferentes:

1. Senha do certificado .pfx: 903205
   - Usada para abrir o arquivo .pfx
   - Fornecida pela Certisign
   - NÃO é a senha do Portal e-SAJ

2. Senha do Portal e-SAJ: [DESCONHECIDA]
   - Cadastrada pelo usuário no site
   - Usada para fazer login
   - Pode ser diferente da senha do .pfx

ERRO IDENTIFICADO:
- Estávamos usando senha do .pfx (903205) para login
- Devemos usar senha do Portal e-SAJ (ainda não temos)

=================================================================================
MODIFICAÇÕES NO CÓDIGO
=================================================================================

Arquivo: crawler_full.py
Função: _maybe_cas_login()
Commit: 09505e0

ANTES (linhas 252-300):
- Tentava certificado PRIMEIRO
- Se falhasse, tentava CPF/senha
- Nunca chegava a tentar CPF/senha (travava no certificado)

DEPOIS (linhas 252-308):
- Tenta CPF/senha PRIMEIRO (linhas 258-262)
- Se funcionar, retorna sucesso
- Fallback para certificado (linhas 265-306)
- Logs mais detalhados

Código modificado:

```python
def _maybe_cas_login(wait, driver, cert_subject_cn, user=None, pwd=None, payload=None):
    if "sajcas/login" not in (driver.current_url or ""):
        debug(payload, "CAS: não precisou logar (já dentro).")
        return
    
    # MODIFICAÇÃO: Tenta CPF/senha PRIMEIRO (certificado requer Web Signer)
    if user and pwd:
        debug(payload, "CAS: tentando login com CPF/CNPJ…")
        if _cas_login_with_password(wait, driver, user, pwd):
            debug(payload, "CAS: login CPF/CNPJ OK."); return
        debug(payload, "CAS: falha no login CPF/CNPJ.")
    
    # Fallback: tenta certificado (provavelmente falhará sem Web Signer)
    try:
        debug(payload, "CAS: tentando aba CERTIFICADO…")
        # ... resto do código de certificado ...
```

BENEFÍCIOS:
- Prioriza método que funciona (CPF/senha)
- Não trava tentando usar certificado
- Logs claros para debug
- Mantém compatibilidade com certificado (se disponível)

=================================================================================
EVIDÊNCIAS COLETADAS
=================================================================================

1. Screenshots (8 imagens):
   - Tentativa login CPF do certificado (falha)
   - Tentativa login com certificado digital (falha)
   - Login bem-sucedido com CPF pessoal
   - Validação 2FA por email
   - Acesso ao Portal e-SAJ confirmado

2. HTML da página de login:
   - Arquivo: erro_0223266_55_2021_8_26_0500_20251001_200332.html
   - Confirma duas abas independentes
   - Mostra popup Web Signer não instalado
   - Dropdown de certificados desabilitado

3. Logs do crawler:
   - log_deploy_21.txt: Configuração do certificado
   - log_deploy_22.txt: Investigação do problema
   - log_deploy_23.txt: Testes de autenticação

=================================================================================
CONFIGURAÇÃO ATUAL
=================================================================================

Arquivo: /opt/crawler_tjsp/.env

# ===== CERTIFICADO DIGITAL =====
CERT_PATH=/app/certs/25424636_pf.pfx
CERT_PASSWORD=903205
CERT_SUBJECT_CN=517.648.902-30
CERT_ISSUER_CN=AC Certisign Múltipla G5

# ===== AUTENTICAÇÃO CAS (CPF/SENHA) =====
CAS_USUARIO=51764890230
CAS_SENHA=903205  # ❌ INCORRETA - É a senha do .pfx, não do Portal

STATUS:
- ✅ Variáveis configuradas no .env
- ✅ docker-compose.yml lê as variáveis
- ✅ Container recebe as variáveis
- ❌ Senha está incorreta (é a senha do .pfx)

Validação:
root@srv987902:/opt/crawler_tjsp# docker compose config | grep CAS
      CAS_SENHA: "903205"
      CAS_USUARIO: "51764890230"

=================================================================================
PRÓXIMOS PASSOS
=================================================================================

### PASSO 1: Validar Credenciais com Detentor do Certificado ###

Perguntas a fazer:

1. Cadastro no Portal:
   - CPF 517.648.902-30 está cadastrado no Portal e-SAJ?
   - URL: https://esaj.tjsp.jus.br/esajperfil/
   - Já fez login alguma vez?

2. Senha do Portal:
   - Qual a senha do Portal e-SAJ?
   - ⚠️ NÃO é a senha do certificado .pfx (903205)
   - É a senha cadastrada no site

3. Perfil da Conta:
   - Tem perfil de advogado?
   - Tem OAB vinculada?
   - Consegue acessar processos manualmente?

4. 2FA (Autenticação de Dois Fatores):
   - A conta tem 2FA habilitado?
   - Se sim, qual email cadastrado?
   - Pode desabilitar para testes?

5. Teste Manual:
   - Fazer login manual agora
   - URL: https://esaj.tjsp.jus.br/sajcas/login
   - Confirmar que funciona

---

### PASSO 2: Após Obter Credenciais Válidas ###

1. Atualizar .env:
   ```bash
   cd /opt/crawler_tjsp
   nano .env
   
   # Atualizar com senha CORRETA do Portal
   CAS_USUARIO=51764890230
   CAS_SENHA=[SENHA_CORRETA_DO_PORTAL]
   ```

2. Testar login manual:
   - Acessar: https://esaj.tjsp.jus.br/sajcas/login
   - Usar credenciais do .env
   - Confirmar que funciona

3. Reiniciar worker:
   ```bash
   docker compose restart worker
   ```

4. Resetar job para teste:
   ```bash
   psql -h 72.60.62.124 -U admin -d n8n -c "
   UPDATE consultas_esaj SET status = FALSE WHERE id = 28;"
   ```

5. Monitorar logs:
   ```bash
   docker compose logs -f worker
   ```

6. Logs esperados (SUCESSO):
   ```
   [INFO] Conectando ao Selenium Grid: http://selenium-chrome:4444
   [INFO] ✅ Conectado ao Selenium Grid com sucesso!
   CAS: tentando login com CPF/CNPJ…
   CAS: login CPF/CNPJ OK.
   [INFO] Processando processo 0223266-55.2021.8.26.0500
   [INFO] ✅ Dados extraídos com sucesso
   ```

=================================================================================
DOCUMENTAÇÃO CRIADA/ATUALIZADA
=================================================================================

1. DEPLOY_TRACKING.md:
   - Atualizado STATUS ATUAL
   - Adicionada entrada [15] com descoberta
   - Documentados testes manuais
   - Próximos passos claramente definidos

2. TROUBLESHOOTING_AUTENTICACAO.md (NOVO):
   - Guia completo de autenticação
   - Métodos de login explicados
   - Problemas comuns e soluções
   - Checklist de validação
   - Testes manuais passo-a-passo
   - Perguntas para detentor do certificado

3. log_deploy_24.txt (ESTE ARQUIVO):
   - Registro completo da descoberta
   - Testes manuais documentados
   - Análise técnica detalhada
   - Próximos passos definidos

4. CERTIFICADO_DIGITAL_SETUP.md:
   - Já existente
   - Documenta configuração do certificado
   - Será atualizado após resolver credenciais

=================================================================================
COMMITS REALIZADOS
=================================================================================

Commit: 09505e0
Mensagem: "fix: prioriza login CPF/senha sobre certificado digital"
Arquivos:
- crawler_full.py (modificado)
- 25424636_pf.pfx (adicionado)
- CERTIFICADO_DIGITAL_SETUP.md (adicionado)
- log_deploys/log_deploy_20.txt (adicionado)

Status: ✅ Pushed para origin/main

=================================================================================
RESUMO EXECUTIVO
=================================================================================

### O QUE FUNCIONA: ###
✅ Selenium Grid operacional (100%)
✅ Worker conecta ao Grid sem erros
✅ Código modificado para login CPF/senha
✅ Sistema de autenticação do e-SAJ testado
✅ Login manual com CPF pessoal funcionou perfeitamente
✅ Infraestrutura técnica completa

### O QUE NÃO FUNCIONA: ###
❌ Credenciais do certificado (CPF 517.648.902-30)
❌ Senha 903205 é do .pfx, não do Portal
❌ Não sabemos a senha correta do Portal e-SAJ

### BLOQUEIO ATUAL: ###
⏸️ Aguardando validação com detentor do certificado
⏸️ Necessário obter senha CORRETA do Portal e-SAJ
⏸️ Necessário confirmar CPF está cadastrado
⏸️ Necessário confirmar conta tem perfil de advogado

### QUANDO RESOLVER: ###
🚀 Atualizar .env com credenciais corretas
🚀 Testar login manual
🚀 Deploy e teste automatizado
🚀 Sistema estará 100% operacional

=================================================================================
ESTATÍSTICAS DO PROJETO
=================================================================================

Total de Tentativas: 15 (incluindo esta)
- Problemas técnicos resolvidos: 13
- Problema atual: Credenciais (não técnico)

Tempo de Investigação: ~15 horas
Commits Totais: 21 commits
Arquivos de Log: 24 arquivos
Documentação: 6 arquivos principais

Progresso:
- Infraestrutura: 100% ✅
- Selenium Grid: 100% ✅
- Código de autenticação: 100% ✅
- Credenciais válidas: 0% ⏸️ (aguardando)

=================================================================================
FIM DO LOG
=================================================================================

Próxima ação: Aguardar resposta do detentor do certificado
Responsável: Detentor do certificado (validação de credenciais)
Prazo: Indefinido (dependente de terceiros)

Quando tiver credenciais válidas:
1. Atualizar .env
2. Testar manualmente
3. Deploy automatizado
4. Validar acesso aos processos
5. Sistema em produção! 🎉
